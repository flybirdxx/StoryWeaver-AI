StoryWeaver AI å…¨æ ˆæ¶æ„é‡æ„è®¾è®¡è“å›¾

ç‰ˆæœ¬: 1.0.0
çŠ¶æ€: Phase 3 å·²å®Œæˆï¼ŒPhase 4 å¾…å¼€å§‹
ç›®æ ‡: æ„å»ºä¸€ä¸ªç±»å‹å®‰å…¨ã€é«˜æ€§èƒ½ã€å¯é•¿æœŸç»´æŠ¤çš„æ™ºèƒ½åˆ†é•œç”Ÿæˆå¹³å°

## ğŸ“Š é‡æ„è¿›åº¦æ€»è§ˆ

### âœ… Phase 1: åŸºç¡€è®¾æ–½æ­å»º (100% å®Œæˆ)
- âœ… Monorepo ç»“æ„å·²åˆå§‹åŒ– (npm workspaces)
- âœ… apps/client (Vite + React + TypeScript) å·²æ­å»º
- âœ… packages/shared å·²åˆ›å»ºå¹¶å®šä¹‰åŸºç¡€ç±»å‹ (Panel, Project)
- âœ… Vite Proxy å·²é…ç½®æŒ‡å‘ TS æœåŠ¡å™¨ (52301)

### âœ… Phase 2: åç«¯ TypeScript åŒ– (100% å®Œæˆ)
- âœ… apps/server ç›®å½•ç»“æ„å·²å»ºç«‹
- âœ… TypeScript + tsx å·²é…ç½®
- âœ… Drizzle ORM å·²å¼•å…¥ï¼Œschema.ts å·²å®šä¹‰ (projects, characters è¡¨)
- âœ… æ‰€æœ‰è·¯ç”±å·²é‡å†™ä¸º TS (projects, characters, script, image, settings)
- âœ… Drizzle ä»“å‚¨å±‚å·²å®ç° (projectRepo, characterRepo)

### âœ… Phase 3: æ ¸å¿ƒåŠŸèƒ½ç§»æ¤ (100% å®Œæˆ)
- âœ… Script Studioï¼šå·²ç”¨ React å®Œæ•´å®ç° (useScriptStudio hook + ScriptPage)
- âœ… Settingsï¼šå·²ç”¨ React å®Œæ•´å®ç° (useSettings hook + SettingsPage)
- âœ… Charactersï¼šå·²ç”¨ React å®Œæ•´å®ç° (useCharacters hook + CharactersPage + CharacterCard)
- âœ… Dashboardï¼šå·²ç”¨ React å®Œæ•´å®ç° (useDashboard hook + DashboardPage + ProjectCard + Chart.js é›†æˆ)
- âœ… Storyboardï¼šå·²ç”¨ React å®Œæ•´å®ç° (useStoryboard hook + StoryboardPage + PanelCard + PanelDetail + SSE æµå¼å›¾åƒç”Ÿæˆ)
  - âœ… åˆ†é•œå¡ç‰‡ç»„ä»¶
  - âœ… dnd-kit æ‹–æ‹½æ’åºï¼ˆå·²å®ç°ï¼Œæ”¯æŒæ‹–æ‹½é‡æ–°æ’åºåˆ†é•œï¼‰
  - âœ… SSE æµå¼é˜Ÿåˆ— API å¯¹æ¥

### âœ… Phase 4: æ¸…ç†ä¸äº¤ä»˜ (100% å®Œæˆ)
- âœ… å·²å½’æ¡£æ—§ä»£ç ï¼ˆåˆ›å»º ARCHIVED_LEGACY_CODE.mdï¼‰
- âœ… é…ç½®ç”Ÿäº§ç¯å¢ƒæ„å»ºè„šæœ¬ï¼ˆVite build + TypeScript buildï¼‰
- âœ… åç«¯æ‰˜ç®¡å‰ç«¯ dist é™æ€èµ„æºï¼ˆç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨åˆ‡æ¢ï¼‰
- âœ… æ•°æ®åº“è¿ç§»ç³»ç»Ÿï¼ˆè‡ªåŠ¨åˆ›å»º jobs è¡¨ï¼‰
- âœ… åˆ›å»ºéƒ¨ç½²æ–‡æ¡£ï¼ˆDEPLOYMENT.mdï¼‰
- ğŸŸ¡ PDF å¯¼å‡ºåŠŸèƒ½ï¼ˆå¯åç»­æ·»åŠ ï¼‰

### ğŸ“¦ æŠ€æœ¯æ ˆå®Œæˆåº¦
- âœ… TypeScriptï¼šå‰åç«¯å·²å…¨é¢ä½¿ç”¨
- âœ… Viteï¼šå·²é…ç½®
- âœ… React 18ï¼šå·²ä½¿ç”¨
- âœ… Zustandï¼šå·²å®‰è£…å¹¶å®ç° useProjectStoreã€useCharacterStoreã€useSettingsStore
- âœ… TanStack Queryï¼šå·²å®‰è£…å¹¶é…ç½®ï¼Œå·²é‡æ„ useCharacters hook ä½¿ç”¨ React Query
- âœ… shadcn/ui + Tailwindï¼šTailwind å·²é…ç½®ä¸ºæœ¬åœ°ç‰ˆæœ¬ï¼Œshadcn/ui åŸºç¡€é…ç½®å·²å®Œæˆï¼ˆcomponents.jsonã€è·¯å¾„åˆ«åã€CSSå˜é‡ï¼‰
- âœ… Expressï¼šå·²ä½¿ç”¨
- âœ… SQLiteï¼šå·²ä½¿ç”¨
- âœ… Drizzle ORMï¼šå·²å¼•å…¥å¹¶éƒ¨åˆ†ä½¿ç”¨ï¼ˆprojectsã€characters è¡¨ï¼‰
- âœ… Zustandï¼šå·²å®‰è£…å¹¶å®ç° useProjectStore
- âœ… Immerï¼šå·²å®‰è£…ï¼ˆç”¨äº Zustand ä¸­é—´ä»¶ï¼‰
- âœ… dnd-kitï¼šå·²å®‰è£…å¹¶é›†æˆåˆ° StoryboardPageï¼Œæ”¯æŒæ‹–æ‹½æ’åºåˆ†é•œ

### ğŸ—‚ï¸ ç›®å½•ç»“æ„å®Œæˆåº¦
- âœ… apps/client/srcï¼šå·²åˆ›å»º
- âœ… apps/client/src/libï¼šAPI å®¢æˆ·ç«¯å·²å®ç°
- âœ… apps/client/src/hooksï¼šè‡ªå®šä¹‰ hooks å·²åˆ›å»ºï¼ˆuseScriptStudioã€useSettingsã€useCharactersã€useDashboardã€useStoryboardï¼‰
- âœ… apps/client/src/pagesï¼šæ‰€æœ‰é¡µé¢ç»„ä»¶å·²åˆ›å»ºï¼ˆScriptPageã€SettingsPageã€CharactersPageã€DashboardPageã€StoryboardPageï¼‰
- âœ… apps/client/src/storesï¼šç›®å½•å·²åˆ›å»ºï¼ˆuseProjectStore å·²å®ç°ï¼ŒZustand + Immer å·²å®‰è£…ï¼‰
- âœ… apps/client/src/featuresï¼šç›®å½•å·²åˆ›å»ºï¼ˆstoryboardã€characters æ¨¡å—å ä½ï¼‰
- âœ… apps/client/src/componentsï¼šç›®å½•å·²åˆ›å»ºï¼ˆButtonã€Cardã€Modal åŸºç¡€ç»„ä»¶ï¼‰
- âœ… apps/server/src/dbï¼šDrizzle Schema å’Œ Repo å·²å®ç°ï¼ˆprojectsã€charactersï¼‰
- âœ… apps/server/src/routesï¼šæ‰€æœ‰è·¯ç”±å·² TS åŒ–ï¼ˆprojectsã€charactersã€scriptã€imageã€settingsï¼‰
- âœ… apps/server/src/servicesï¼šç›®å½•å·²åˆ›å»ºï¼ˆå¾…è¿ç§»æ—§ JS servicesï¼‰
- âœ… apps/server/src/queueï¼šç›®å½•å·²åˆ›å»ºï¼ˆå¾…å®ç° Job Queueï¼‰
- âœ… packages/shared/srcï¼šåŸºç¡€ç±»å‹å·²å®šä¹‰ï¼ˆPanelã€Projectï¼‰

1. æ ¸å¿ƒè®¾è®¡ç†å¿µ

ä¸ºäº†è§£å†³ç°æœ‰æ¶æ„ä¸­å‰ç«¯çŠ¶æ€æ··ä¹±ã€ç±»å‹ä¸å®‰å…¨ä»¥åŠ AI ç”Ÿæˆä»»åŠ¡ä¸å¯æ§çš„é—®é¢˜ï¼Œæ–°æ¶æ„éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

å‰åç«¯åˆ†ç¦»ä½†ä»£ç å…±å­˜ (Monorepo)ï¼šå‰ç«¯ (React) å’Œåç«¯ (Node.js) åœ¨åŒä¸€ä¸ªä»“åº“ä¸­ç®¡ç†ï¼Œå…±äº« TypeScript ç±»å‹å®šä¹‰ï¼Œç¡®ä¿æ¥å£å¥‘çº¦çš„ä¸€è‡´æ€§ã€‚

å•ä¸€æ•°æ®æº (Single Source of Truth)ï¼š

æŒä¹…åŒ–æ•°æ®ï¼šä»¥åç«¯ SQLite æ•°æ®åº“ä¸ºå‡†ã€‚

è¿è¡Œæ—¶çŠ¶æ€ï¼šä»¥å‰ç«¯ Zustand Store ä¸ºå‡†ï¼Œä¸¥ç¦ä¾èµ– DOM è¯»å–çŠ¶æ€ã€‚

å…¨é“¾è·¯ç±»å‹å®‰å…¨ (End-to-End Type Safety)ï¼šä»æ•°æ®åº“ Schema åˆ° API å“åº”ï¼Œå†åˆ°å‰ç«¯ç»„ä»¶ï¼Œå…¨éƒ¨ä½¿ç”¨ TypeScriptï¼Œæœ€å¤§é™åº¦å‡å°‘è¿è¡Œæ—¶é”™è¯¯ã€‚

å¼‚æ­¥ä»»åŠ¡é©±åŠ¨ (Job Driven)ï¼šæ‰€æœ‰è€—æ—¶çš„ AI ç”Ÿæˆè¯·æ±‚ï¼ˆå›¾ç‰‡/è§†é¢‘ï¼‰å¿…é¡»è¿›å…¥æŒä¹…åŒ–é˜Ÿåˆ—ï¼Œé€šè¿‡çŠ¶æ€æœºæµè½¬ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œå¹¶å‘æ§åˆ¶ã€‚

2. æŠ€æœ¯æ ˆé€‰å‹ (Tech Stack)

é¢†åŸŸ

é€‰å‹

ç†ç”±

è¯­è¨€

TypeScript

é•¿æœŸç»´æŠ¤çš„åŸºçŸ³ï¼Œæä¾›æ™ºèƒ½æç¤ºä¸ç¼–è¯‘æ—¶æ£€æŸ¥ã€‚

æ„å»ºå·¥å…·

Vite

æé€Ÿçš„å¼€å‘æœåŠ¡å™¨å’Œæ„å»ºæ€§èƒ½ã€‚

å‰ç«¯æ¡†æ¶

React 18

ç»„ä»¶åŒ–ç”Ÿæ€æœ€ä¸°å¯Œï¼Œé€‚åˆæ„å»ºå¤æ‚çš„äº¤äº’ç•Œé¢ï¼ˆå¦‚æ•…äº‹æ¿ï¼‰ã€‚

çŠ¶æ€ç®¡ç†

Zustand

ç®€æ´ã€é«˜æ€§èƒ½ï¼Œå®Œç¾æ›¿ä»£ Context APIï¼Œé€‚åˆå¤„ç†å¤æ‚å¯¹è±¡ï¼ˆå¦‚åˆ†é•œåˆ—è¡¨ï¼‰ã€‚

æ•°æ®è¯·æ±‚

TanStack Query

è‡ªåŠ¨å¤„ç†æœåŠ¡ç«¯çŠ¶æ€çš„ç¼“å­˜ã€å»é‡ã€è½®è¯¢å’Œä¹è§‚æ›´æ–°ã€‚

UI ç³»ç»Ÿ

shadcn/ui + Tailwind

ç°ä»£åŒ–çš„ç»„ä»¶åº“æ–¹æ¡ˆï¼Œæä¾›æé«˜çš„å®šåˆ¶è‡ªç”±åº¦ã€‚

åç«¯æ¡†æ¶

Express

æˆç†Ÿç¨³å®šï¼Œç°æœ‰ä¸šåŠ¡é€»è¾‘è¿ç§»æˆæœ¬ä½ã€‚

æ•°æ®åº“

SQLite

å•æ–‡ä»¶æ•°æ®åº“ï¼Œéƒ¨ç½²æå…¶ç®€å•ï¼Œéå¸¸é€‚åˆå•æœº/ç§æœ‰åŒ–éƒ¨ç½²å·¥å…·ã€‚

ORM

Drizzle ORM

è½»é‡çº§ã€ç±»å‹å®‰å…¨ï¼Œç”Ÿæˆçš„ SQL æ€§èƒ½é«˜ï¼ŒSchema å®šä¹‰æ¸…æ™°ã€‚

äº¤äº’åº“

dnd-kit

ä¸“é—¨å¤„ç†å¤æ‚æ‹–æ‹½åœºæ™¯ï¼ˆå¦‚åˆ†é•œæ’åºã€ç´ ææ”¾ç½®ï¼‰ã€‚

3. Monorepo ç›®å½•ç»“æ„è§„èŒƒ

é‡‡ç”¨ pnpm workspaces æˆ– npm workspaces è¿›è¡Œç®¡ç†ã€‚

storyweaver-ai/
â”œâ”€â”€ package.json          # æ ¹é…ç½® (å®šä¹‰ workspaces)
â”œâ”€â”€ tsconfig.json         # å…¨å±€ TS é…ç½® (paths æ˜ å°„)
â”œâ”€â”€ apps/                 # åº”ç”¨ç¨‹åºç›®å½•
â”‚   â”œâ”€â”€ client/           # [å‰ç«¯] Vite + React App
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ components/  # é€šç”¨ UI ç»„ä»¶ (Button, Card...)
â”‚   â”‚   â”‚   â”œâ”€â”€ features/    # ä¸šåŠ¡åŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ storyboard/ # æ•…äº‹æ¿æ ¸å¿ƒ (æ‹–æ‹½ã€æ¸²æŸ“)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ script/     # å‰§æœ¬ç¼–è¾‘å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ characters/ # è§’è‰²ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ stores/      # Zustand å…¨å±€çŠ¶æ€
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/         # å·¥å…·å‡½æ•° (API Client)
â”‚   â”‚   â”‚   â””â”€â”€ hooks/       # è‡ªå®šä¹‰ Hooks (useAIQueue)
â”‚   â”‚   â””â”€â”€ vite.config.ts
â”‚   â”‚
â”‚   â””â”€â”€ server/           # [åç«¯] Express App
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ db/          # Drizzle Schema å®šä¹‰
â”‚       â”‚   â”œâ”€â”€ routes/      # API è·¯ç”±æ§åˆ¶å™¨
â”‚       â”‚   â”œâ”€â”€ services/    # ä¸šåŠ¡é€»è¾‘ (AI Service, Queue Service)
â”‚       â”‚   â”œâ”€â”€ queue/       # ä»»åŠ¡é˜Ÿåˆ—å¤„ç†å™¨
â”‚       â”‚   â””â”€â”€ index.ts     # å…¥å£æ–‡ä»¶
â”‚       â””â”€â”€ package.json
â”‚
â””â”€â”€ packages/             # [å…±äº«åŒ…]
    â””â”€â”€ shared/           # å‰åç«¯å…±ç”¨ä»£ç 
        â”œâ”€â”€ index.ts      # å¯¼å‡ºç±»å‹å®šä¹‰ (interface Panel, API Responses)
        â””â”€â”€ package.json


4. å…³é”®ç³»ç»Ÿæ¨¡å—è®¾è®¡

4.1 ç»Ÿä¸€æ•°æ®å±‚ (Drizzle ORM) ğŸŸ¡ **éƒ¨åˆ†å®Œæˆ**

âœ… æ”¾å¼ƒæ‰‹å†™ SQL å­—ç¬¦ä¸²ï¼Œä½¿ç”¨ Drizzle å®šä¹‰å¼ºç±»å‹çš„ Schemaã€‚

âœ… å·²å®ç°ï¼šprojects è¡¨ã€characters è¡¨çš„ Drizzle Schemaã€‚

âœ… å·²å®ç°ï¼šprojectRepoã€characterRepo ä»“å‚¨å±‚ã€‚

âŒ æœªå®ç°ï¼španels è¡¨çš„ Drizzle Schemaï¼ˆå½“å‰ schema.ts ä¸­åªæœ‰ projects å’Œ charactersï¼‰ã€‚

âŒ æœªå®ç°ï¼španels è¡¨çš„ä»“å‚¨å±‚ã€‚

// apps/server/src/db/schema.ts
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';

// âœ… å·²å®ç°ï¼šprojects å’Œ characters è¡¨
// âŒ å¾…å®ç°ï¼španels è¡¨
export const panels = sqliteTable('panels', {
  id: text('id').primaryKey(), // UUID
  projectId: text('project_id').notNull(),
  panelIndex: integer('panel_index').notNull(),
  prompt: text('prompt'),
  imageUrl: text('image_url'),
  // çŠ¶æ€æœºç®¡ç†
  status: text('status', { enum: ['pending', 'generating', 'completed', 'failed'] }).default('pending'),
  updatedAt: integer('updated_at', { mode: 'timestamp' }),
});

// è‡ªåŠ¨æ¨å¯¼ç±»å‹ä¾›å‰ç«¯ä½¿ç”¨
// export type Panel = typeof panels.$inferSelect;


4.2 å“åº”å¼å‰ç«¯çŠ¶æ€ (Zustand + Immer) âœ… **å·²å®ç°**

âœ… Zustand å’Œ Immer å·²å®‰è£…å¹¶é…ç½®å®Œæˆã€‚

âœ… `useProjectStore` å·²å®ç°ï¼Œæä¾›å…¨å±€é¡¹ç›®çŠ¶æ€ç®¡ç†ï¼š
- åˆ†é•œåˆ—è¡¨ç®¡ç† (`panels`)
- å½“å‰é¡¹ç›® ID (`currentProjectId`)
- é€‰ä¸­åˆ†é•œ ID (`selectedPanelId`)
- åˆ†é•œçŠ¶æ€æ›´æ–° (`updatePanelStatus`, `updatePanelImage`)
- åˆ†é•œå¢åˆ  (`addPanel`, `removePanel`)

âœ… å·²è¿ç§»ï¼š`useStoryboard` hook å·²è¿ç§»åˆ°ä½¿ç”¨ `useProjectStore` ç®¡ç†åˆ†é•œåˆ—è¡¨å’Œé€‰ä¸­çŠ¶æ€ã€‚
âœ… å·²è¿ç§»ï¼š`useDashboard` hook å·²è¿ç§»åˆ°ä½¿ç”¨ `useProjectStore` ç®¡ç†é¡¹ç›®åˆ—è¡¨å’Œå½“å‰é¡¹ç›®ã€‚
âœ… å·²è¿ç§»ï¼š`useCharacters` hook å·²è¿ç§»åˆ°ä½¿ç”¨ `useCharacterStore` ç®¡ç†è§’è‰²åˆ—è¡¨ã€‚
âœ… å·²è¿ç§»ï¼š`useSettings` hook å·²è¿ç§»åˆ°ä½¿ç”¨ `useSettingsStore` ç®¡ç† API Keysã€‚
âœ… å…¨å±€çŠ¶æ€ï¼š`panels`ã€`selectedPanelId`ã€`projects`ã€`currentProject`ã€`characters`ã€`geminiApiKey`ã€`deepseekApiKey` ç°åœ¨ç”± Zustand Store ç»Ÿä¸€ç®¡ç†ï¼Œå¯åœ¨å¤šä¸ªç»„ä»¶é—´å…±äº«ã€‚
âœ… Store æ¶æ„ï¼š
  - `useProjectStore`ï¼šé¡¹ç›®ç®¡ç†å’Œåˆ†é•œç®¡ç†
  - `useCharacterStore`ï¼šè§’è‰²åˆ—è¡¨ç®¡ç†
  - `useSettingsStore`ï¼šAPI Keys è®¾ç½®ç®¡ç†
âœ… çŠ¶æ€ç®¡ç†å®Œæˆåº¦ï¼šæ‰€æœ‰ä¸»è¦ä¸šåŠ¡çŠ¶æ€å·²è¿ç§»åˆ° Zustand Storeï¼Œå®ç°äº†çœŸæ­£çš„å…¨å±€çŠ¶æ€ç®¡ç†ã€‚
ğŸŸ¡ UI çŠ¶æ€ï¼š`isLoading`ã€`isGenerating`ã€`error`ã€`testResult` ä¿æŒä¸ºå±€éƒ¨çŠ¶æ€ï¼ˆUI çŠ¶æ€ä¸éœ€è¦å…¨å±€ï¼‰ã€‚

// apps/client/src/stores/useProjectStore.ts
// âœ… å·²å®ç°
import { create } from 'zustand';
import { immer } from 'zustand/middleware/immer';
import type { Panel, PanelStatus } from '@storyweaver/shared';

export interface ProjectState {
  panels: Panel[];
  currentProjectId: string | null;
  selectedPanelId: string | number | null;
  setPanels: (panels: Panel[]) => void;
  updatePanelStatus: (id: string | number, status: PanelStatus, url?: string) => void;
  updatePanelImage: (id: string | number, imageUrl: string, isUrl?: boolean) => void;
  setCurrentProjectId: (id: string | null) => void;
  setSelectedPanelId: (id: string | number | null) => void;
  addPanel: (panel: Panel) => void;
  removePanel: (id: string | number) => void;
}

export const useProjectStore = create<ProjectState>()(
  immer((set) => ({
    panels: [],
    currentProjectId: null,
    selectedPanelId: null,
    // ... å®Œæ•´å®ç°å·²åˆ›å»º
  }))
);


4.3 å¥å£®çš„ AI ä»»åŠ¡é˜Ÿåˆ— (Job Queue) âœ… **å·²å®ç°**

âœ… åç«¯å·²å®ç°åŸºäºæ•°æ®åº“çš„é˜Ÿåˆ—ç³»ç»Ÿã€‚

âœ… å·²å®ç°åŠŸèƒ½ï¼š
- âœ… å…¥é˜Ÿï¼šå‰ç«¯å‘èµ·è¯·æ±‚ -> åç«¯æ’å…¥ DB (Status: pending) -> ç«‹å³è¿”å› HTTP 200ã€‚
- âœ… å¤„ç†ï¼šåå° Worker è¯»å– pending ä»»åŠ¡ -> è°ƒç”¨ Gemini API -> æ›´æ–° DB (Status: completed)ã€‚
- âœ… æŸ¥è¯¢ï¼šå‰ç«¯å¯é€šè¿‡ `/api/image/job/:jobId` æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ã€‚
- âœ… æ‰¹é‡å…¥é˜Ÿï¼šæ”¯æŒæ‰¹é‡å°†å¤šä¸ªå›¾åƒç”Ÿæˆä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ã€‚

âœ… æŠ€æœ¯å®ç°ï¼š
- âœ… `jobs` è¡¨ï¼šå­˜å‚¨ä»»åŠ¡ä¿¡æ¯ï¼ˆid, type, status, payload, result, error, retryCount ç­‰ï¼‰
- âœ… `jobRepo.ts`ï¼šä»»åŠ¡æ•°æ®åº“æ“ä½œå±‚ï¼ˆcreateJob, getPendingJobs, updateJob ç­‰ï¼‰
- âœ… `queue/processor.ts`ï¼šä»»åŠ¡å¤„ç†å™¨ï¼ˆprocessImageGenerationJob, processJobï¼‰
- âœ… `queue/worker.ts`ï¼šåå° Workerï¼ˆè½®è¯¢å¤„ç† pending ä»»åŠ¡ï¼Œæ”¯æŒå¹¶å‘æ§åˆ¶ï¼‰
- âœ… è·¯ç”±ç«¯ç‚¹ï¼š
  - `POST /api/image/generate-queue` - å•ä¸ªä»»åŠ¡å…¥é˜Ÿ
  - `POST /api/image/generate-batch-queue` - æ‰¹é‡ä»»åŠ¡å…¥é˜Ÿ
  - `GET /api/image/job/:jobId` - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

ğŸŸ¡ å‰ç«¯é›†æˆï¼šå½“å‰å‰ç«¯ä»ä½¿ç”¨ SSE æµå¼å¤„ç†ï¼ˆ`/api/image/generate-batch-stream`ï¼‰ï¼Œå¯åç»­è¿ç§»åˆ°é˜Ÿåˆ—ç³»ç»Ÿã€‚

ğŸ“ æ³¨æ„ï¼šå½“å‰ `/api/image/generate-batch-stream` ä½¿ç”¨ SSE æµå¼è¿”å›ï¼Œé˜Ÿåˆ—ç³»ç»Ÿä½œä¸ºæ–°çš„å¯é€‰æ–¹æ¡ˆã€‚

5. æ¸è¿›å¼è¿ç§»è·¯çº¿å›¾ (Migration Roadmap)

ä¸ºäº†é™ä½é£é™©ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é˜¶æ®µè¿›è¡Œè¿ç§»ï¼š

Phase 1: åŸºç¡€è®¾æ–½æ­å»º (Side-by-Side) âœ… **å·²å®Œæˆ**

âœ… åˆå§‹åŒ– Monorepo ç»“æ„ã€‚

âœ… æ­å»º apps/client (Vite + React)ï¼Œé…ç½® Proxy æŒ‡å‘ TS åç«¯ç«¯å£ (52301)ã€‚

âœ… æ­å»º packages/sharedï¼Œå®šä¹‰åˆæ­¥çš„ç±»å‹ (Panel, Project)ã€‚

âœ… ç›®æ ‡ï¼šåœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼ŒReact å‰ç«¯èƒ½æˆåŠŸè°ƒç”¨ç°æœ‰çš„ Express APIã€‚

Phase 2: åç«¯ TypeScript åŒ– âœ… **å·²å®Œæˆ**

âœ… å°† server/ ç§»å…¥ apps/serverï¼ˆä¿ç•™æ—§ server/ ç›®å½•ä»¥å…¼å®¹ï¼‰ã€‚

âœ… å¼•å…¥ typescript å’Œ tsx (è¿è¡Œå·¥å…·)ã€‚

âœ… å¼•å…¥ drizzle-ormï¼Œæ ¹æ®ç°æœ‰ SQLite ç»“æ„ç¼–å†™ schema.ts (projects, characters è¡¨)ã€‚

âœ… å°†è·¯ç”±é€æ­¥é‡å†™ä¸º TS (projects, characters, script, image, settings å…¨éƒ¨å®Œæˆ)ã€‚

ğŸŸ¡ Service å±‚ä»ä½¿ç”¨æ—§ JS å®ç°ï¼ˆå¯åç»­è¿ç§»ï¼‰ã€‚

âœ… ç›®æ ‡ï¼šåç«¯è·å¾—ç±»å‹æ£€æŸ¥èƒ½åŠ›ï¼Œæ•°æ®åº“æ“ä½œæ›´åŠ å®‰å…¨ã€‚

Phase 3: æ ¸å¿ƒåŠŸèƒ½ç§»æ¤ (The Big Refactor) âœ… **100% å®Œæˆ**

âœ… Dashboardï¼šå·²ç”¨ React å®Œæ•´å®ç°ï¼ˆuseDashboard hook + DashboardPage + ProjectCard ç»„ä»¶ + Chart.js æ•°æ®å¯è§†åŒ–ï¼‰ã€‚

âœ… Script Studioï¼šå·²ç”¨ React å®Œæ•´å®ç°ï¼ˆuseScriptStudio hook + ScriptPage ç»„ä»¶ï¼‰ã€‚

âœ… Charactersï¼šå·²ç”¨ React å®Œæ•´å®ç°ï¼ˆuseCharacters hook + CharactersPage + CharacterCard ç»„ä»¶ï¼‰ã€‚

âœ… Settingsï¼šå·²ç”¨ React å®Œæ•´å®ç°ï¼ˆuseSettings hook + SettingsPage ç»„ä»¶ï¼‰ã€‚

âœ… Storyboardï¼šå·²ç”¨ React å®Œæ•´å®ç°ï¼ˆuseStoryboard hook + StoryboardPage + PanelCard + PanelDetail ç»„ä»¶ï¼‰ã€‚
  - âœ… å®ç°åˆ†é•œå¡ç‰‡ç»„ä»¶
  - âœ… SSE æµå¼å›¾åƒç”Ÿæˆé˜Ÿåˆ— API å¯¹æ¥ï¼ˆ/generate-batch-streamï¼‰
  - âœ… dnd-kit æ‹–æ‹½æ’åºï¼ˆå·²å®ç°ï¼Œæ”¯æŒæ‹–æ‹½é‡æ–°æ’åºåˆ†é•œï¼‰

ç›®æ ‡ï¼šå®Œå…¨æ›¿ä»£ public/ ç›®å½•ä¸‹çš„ HTML/JS åŠŸèƒ½ã€‚**å½“å‰è¿›åº¦ï¼š5/5 æ¨¡å—å®Œæˆ âœ…**

Phase 4: æ¸…ç†ä¸äº¤ä»˜ âœ… **å·²å®Œæˆ**

âœ… å·²å½’æ¡£æ—§ä»£ç ï¼šåˆ›å»º `ARCHIVED_LEGACY_CODE.md` è®°å½•è¿ç§»å†å²ã€‚

âœ… é…ç½®ç”Ÿäº§ç¯å¢ƒæ„å»ºè„šæœ¬ï¼š
  - âœ… Vite æ„å»ºé…ç½®ï¼ˆä»£ç åˆ†å‰²ã€ä¼˜åŒ–ï¼‰
  - âœ… æ ¹ç›®å½•æ·»åŠ  `build`ã€`build:all` è„šæœ¬
  - âœ… æœåŠ¡å™¨æ·»åŠ  `build`ã€`start` è„šæœ¬

âœ… åç«¯æ‰˜ç®¡å‰ç«¯é™æ€èµ„æºï¼š
  - âœ… ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨æ‰˜ç®¡ `apps/client/dist`
  - âœ… SPA è·¯ç”±å›é€€æ”¯æŒ
  - âœ… å¼€å‘ç¯å¢ƒä¿æŒå‘åå…¼å®¹ï¼ˆä½¿ç”¨æ—§çš„ public ç›®å½•ï¼‰

âœ… æ•°æ®åº“è¿ç§»ç³»ç»Ÿï¼š
  - âœ… åˆ›å»º `migrations.ts` è„šæœ¬
  - âœ… è‡ªåŠ¨åˆ›å»º `jobs` è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  - âœ… æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œè¿ç§»

ğŸŸ¡ æ—§ä»£ç æ¸…ç†ï¼šæ—§ä»£ç å·²å½’æ¡£ä½†æœªåˆ é™¤ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼Œå¾…æ–°ç‰ˆæœ¬å®Œå…¨ç¨³å®šåæ¸…ç†ï¼‰ã€‚

ğŸŸ¡ PDF å¯¼å‡ºåŠŸèƒ½ï¼šå¯åç»­æ·»åŠ ï¼ˆå½“å‰ä¼˜å…ˆçº§è¾ƒä½ï¼‰ã€‚

6. é•¿æœŸç»´æŠ¤ä»·å€¼åˆ†æ

é‡‡ç”¨æ­¤æ¶æ„åï¼Œæœªæ¥çš„ç»´æŠ¤å’Œæ‰©å±•å°†å˜å¾—æå…¶ç®€å•ï¼š

å¢åŠ æ–°å±æ€§ï¼šåªéœ€åœ¨ schema.ts æ·»åŠ å­—æ®µï¼Œè¿è¡Œ migrationï¼Œå‰åç«¯ç±»å‹è‡ªåŠ¨æŠ¥é”™æç¤ºä¿®æ”¹ï¼Œä¸å†æ‹…å¿ƒæ¼æ”¹ã€‚

å¤šäººåä½œï¼šæ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼ˆç»„ä»¶/çŠ¶æ€/æœåŠ¡ï¼‰ï¼Œè®©å¤šäººåŒæ—¶å¼€å‘äº’ä¸å¹²æ‰°ã€‚

å¤æ‚äº¤äº’ï¼šReact ç”Ÿæ€æ‹¥æœ‰æµ·é‡çš„ç°æˆåº“ï¼ˆå¦‚ react-resizable-panels, react-zoom-pan-pinchï¼‰ï¼Œå®ç°ä¸“ä¸šçº§å·¥å…·çš„ç¼©æ”¾ã€å¹³ç§»é¢æ¿ä¸å†æ˜¯éš¾äº‹ã€‚

æ€§èƒ½ç›‘æ§ï¼šTanStack Query æä¾›äº†å¼€ç®±å³ç”¨çš„åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†ï¼Œç”¨æˆ·ä½“éªŒå¤§å¹…æå‡ã€‚